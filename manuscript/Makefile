# Build the PDF of the manuscript.
#
# Commands:
#
#	make            Compile PDF in the output folder
#	make show       Show the generated PDF
#	make wc         Count the number of words in manuscript
#	lint			Check the text for common mistakes
#	make clean      Delete all generated files

# CONFIGURATION
###############################################################################

# The name of the main .tex file to build.
# Other latex files should be included into this one.
PROJECT = manuscript
# Folder with the figure files
FIGDIR = figures
# Folder where output will be placed
OUTDIR = output
# Name of the output file
OUTPUT = $(OUTDIR)/$(PROJECT).pdf

### File Types (for dependencies)
MD = $(wildcard *.md)
TEX = $(wildcard *.tex)
BIB = $(wildcard *.bib)
STY = $(wildcard *.sty)
CLS = $(wildcard *.cls)
BST = $(wildcard *.bst)
EPS = $(wildcard $(FIGDIR)/*.eps)
PNG = $(wildcard $(FIGDIR)/*.png)
PDF = $(wildcard $(FIGDIR)/*.pdf)
JPG = $(wildcard $(FIGDIR)/*.jpg)
FIGS = $(EPS) $(PNG) $(PDF) $(JPG)

### Compilation Flags
LATEX_FLAGS  = -halt-on-error -output-directory $(OUTDIR)/

### Set commands for opening the generated PDF
UNAME := $(shell uname)
ifeq ($(UNAME), Linux)
PDFVIEWER = xdg-open
endif
ifeq ($(UNAME), Darwin)
PDFVIEWER = open
endif
ifeq ($(UNAME), CYGWIN_NT-10.0)
PDFVIEWER = cygstart
endif


# TARGETS
###############################################################################

# Main target. Executed when calling 'make' with no arguments
all: $(OUTPUT)

# Open the PDF
show: $(OUTPUT)
	@ # Redirect stdout and stderr to /dev/null for silent execution
	@ (${PDFVIEWER} $(OUTPUT) > /dev/null 2>&1 & )

# Count the number of words in the manuscript. Not perfect and will skip any
# included files.
wc:
	@ detex $(PROJECT).tex | wc -w

# Check the text for common mistakes
lint:
	@ proselint $(PROJECT).tex

### Clean
# This target cleans the temporary files generated by the tex programs in
# use. All temporary files generated by this makefile will be placed in OUTDIR
# so cleanup is easy.
clean::
	rm -rf $(OUTDIR)/*.aux
	rm -rf $(OUTDIR)/*.log
	rm -rf $(OUTDIR)/*out
	rm -rf $(OUTDIR)/*blg
	rm -rf $(FIGDIR)/*-eps-converted-to.pdf

# Compile the PDF output
$(OUTPUT): $(PROJECT).tex $(STY) $(CLS) $(BIB) $(BST) $(FIGS) $(TEX) $(MD)
	# Create the output directory if it doesn't exist
	pandoc article.md -o content.tex
	mkdir -p $(OUTDIR)/
	cp $(BIB) $(BST) $(OUTDIR)
	pdflatex $(LATEX_FLAGS) $<
	cd $(OUTDIR) && bibtex $(patsubst %.tex,%,$<)
	pdflatex $(LATEX_FLAGS) $< 1>/dev/null
	pdflatex $(LATEX_FLAGS) $< 1>/dev/null